# æ’ˆæ•¸æ“šèªæ³•èªªæ˜





å¯ä»¥é€™æ¨£ç”¨ã€Œèªªæ˜èªæ³•ã€çš„é¢¨æ ¼ç°¡æ˜“ç¸½çµé€™æ®µç¨‹å¼ï¼š

```python
# ä½¿ç”¨ broadcast joinï¼ŒæŠŠ AI Camera äº‹ä»¶è³‡æ–™ (df_ai) èˆ‡ Place ç¶­åº¦è¡¨ (df_place) åˆä½µ
df_ai_with_place = df_ai.join(
    broadcast(df_place),  # å°‡å°è¡¨ df_place å»£æ’­åˆ°æ‰€æœ‰ç¯€é»ï¼ŒåŠ é€Ÿ join
    (
        # join æ¢ä»¶ï¼š
        # 1ï¸âƒ£ å„ªå…ˆç”¨è£ç½® ID (cid == did)
        # 2ï¸âƒ£ è‹¥ç„¡æ³•åŒ¹é…ï¼Œå†ç”¨ city + district + address æ¯”å°
        (df_ai["cid"] == df_place["did"]) |
        ((df_ai["city"] == df_place["place_city"]) &
         (df_ai["district"] == df_place["place_district"]) &
         (df_ai["address"] == df_place["place_address"]))
    ),
    "left"  # å·¦å¤–é€£æ¥ï¼Œä¿ç•™æ‰€æœ‰ AI Camera ç´€éŒ„
).select(
    df_ai["*"],  # ä¿ç•™æ‰€æœ‰ AI Camera åŸå§‹æ¬„ä½
    col("did").alias("screen_id"),  # çµ±ä¸€å‘½åè¢å¹• ID
    # ä½¿ç”¨ coalesceï¼šè‹¥ AI Camera æ¬„ä½ç‚º nullï¼Œå‰‡ç”¨ place æ¬„ä½è£œä¸Š
    coalesce(df_ai["city"], col("place_city")).alias("city_final"),
    coalesce(df_ai["district"], col("place_district")).alias("district_final"),
    coalesce(df_ai["town"], col("place_town")).alias("town_final"),
    coalesce(df_ai["address"], col("place_address")).alias("address_final"),
    coalesce(df_ai["longitude"], col("place_lng")).alias("longitude_final"),
    coalesce(df_ai["latitude"], col("place_lat")).alias("latitude_final"),
    coalesce(df_ai["area_name"], col("place_area_name")).alias("area_name_final")
)
```

---

### ğŸ’¡ èªæ³•é‡é»æ•´ç†

| åŠŸèƒ½ | èªæ³• | èªªæ˜ |  | 
|---|---|---|---|
| å»£æ’­å°è¡¨ | `broadcast(df_place)` | åŠ é€Ÿ joinï¼Œé©åˆå°ç¶­åº¦è¡¨ |  | 
| æ¢ä»¶çµ„åˆ | \` | `ã€`&\` | ORã€ANDï¼Œå»ºç«‹è¤‡åˆæ¢ä»¶ | 
| join é¡å‹ | `"left"` | å·¦å¤–é€£æ¥ï¼Œä¿ç•™ä¸»è¡¨ (AI Camera) å…¨éƒ¨ç´€éŒ„ |  | 
| æ¬„ä½å…¨å– | `df_ai["*"]` | ä¿ç•™æ‰€æœ‰ä¸»è¡¨æ¬„ä½ |  | 
| æ”¹å | `.alias("æ–°åç¨±")` | çµ±ä¸€æ¬„ä½å‘½å |  | 
| æ¬„ä½è£œå€¼ | `coalesce(a, b)` | è‹¥ a ç‚º nullï¼Œä½¿ç”¨ b |  | 
| çµæœå‘½å | `*_final` | çµ±ä¸€æœ€çµ‚è¼¸å‡ºæ¬„ä½å‘½å |  | 

---

é€™æ¨£çš„ç¨‹å¼æ¨¡å¼æ˜¯ Spark ETL è£¡å¸¸è¦‹çš„ï¼šã€Œ**å¤§è¡¨äº‹ä»¶ + å°è¡¨ç¶­åº¦ï¼Œç”¨ broadcast join åˆä½µä¸¦æ¨™æº–åŒ–è¼¸å‡º**ã€ã€‚


