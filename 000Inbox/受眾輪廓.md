---
tags:
  - general-ad-play-platform
---
# 受眾輪廓

## \[Question\]

根據以下內容，幫我做規劃設計:

我想分析零售商店實體電子看板的受眾輪廓，目前我們感應器能偵測人的停留、觀看數據，未來可能還會加入 Beacon 偵測受眾在店內哪一區，或是紅外線、踩踏板、甚至 LLM 分析影像...等，因此我們必須想一個通用的人流輪廓 Delta Table Schema，讓不同感測器能夠有機會一起分析，這個 Schema 有點像是特徵的組合!

\[ 限制/可能問題\]
1\.我們不同感測器，目前無法識別受眾是否為同一人，也就是臉部偵測的 audience_id 無法跟 Beacon 的 audience_id 比對
2\. 因為客戶成本考量，我們臉部偵測目前無法辨識是否為同一人
3\. 其他 Sensor 加進來要可以一起分析

\[其他想法\]

1. 各自 Sensor 可以保有自己事件驅動的數據，一起分析的話可以 By 週期彙整 ( EX: 每小時，所有特徵欄位下的觀看數、總觀看率...)

2. 一間店如果 By 觀看廣告每小時彙整的話，有可能其總和的人流或觀看數會大於實際( 因為一個人可以看  A 廣告，也可以接著看 B 廣告)，如果沒有好解法就另外產生總數的欄位

\[欄位名稱(特徵)初步想法\] 目前想法是分三大類:

1. 受眾行為/表徵  ( 感測器數據為主)

. 年齡、性別

. 出現、離開

. 觀看開始、觀看結束

. 待在內部哪一區

1. 場域/區域/地點相關(感測器是裝在哪裡):

. 縣市、行政區域

. 都市計畫區域

. 附近地標

. 場域標籤(EX: 便利商店的高營收店)  

1. 時間相關(與廣告播放重疊時間)

. 時段、假日、節慶

. 天氣

\[ 理想上這個 Table 可以一起分析的原因如下\]

篩選某間便利商店數據後，可以得到:

中午時段觀看率特別高

上午人流特別多

下午熱食區逗留特別久

我們可以根據以上資訊去媒合，該怎麼下廣告給該店比較合適





## \[Answer\]

- 限制: 無法跨感測器/跨時間識別同一人

- 想法: 按週期彙整這對 Schema 設計有重大影響，我們需要調整策略

單純「事件明細表」雖然能儲存最原始數據，但在進行你期望的「彙總性分析」（例如：中午時段觀看率、上午人流）時，會需要較複雜的即時查詢。因此，**採用一個以「週期性彙總」為主的 Delta Table Schema，同時保留一個（可選的）事件明細表作為底層數據源**，會是更符合你需求的做法。



### 以下針對「週期性彙總」表的規劃設計：

**核心概念調整：**

- \*\*主要分析表：週期彙總表 (Aggregated Summary Table)\*\*。這張表直接儲存按固定時間週期（例如：每小時）彙整後的指標，方便快速查詢趨勢。

- **粒度 (Granularity)：** Store (商店) x Sensor/Zone (感測器/區域) x Time Period (時間週期，如小時) x Audience Segment (受眾分群，如年齡/性別) x \[Optional\] Content (廣告內容)。

- **數據來源：** 這張彙總表需要透過一個 ETL/ELT 流程，從各個感測器的原始事件數據（可能儲存在另一個更明細的 Delta Table 或其他來源）加工計算而來。

- **解決無法識別同一人問題：** 我們不再嘗試追蹤「個人」，而是計算在特定時間、地點、條件下的「互動次數」、「估計人數」、「平均行為指標」等彙總數據。

**彙總表 Schema 設計建議 (Aggregated Hourly Summary):**

```text
-- Delta Table Name: retail_hourly_summary

-- 維度欄位 (Dimensions - 用於 GROUP BY 和 FILTER)
store_id STRING -- 商店唯一識別碼
aggregation_timestamp TIMESTAMP -- 彙總週期的開始時間 (例如: 2025-04-18 13:00:00) (當地時間)
year INTEGER
month INTEGER
day INTEGER
hour_of_day INTEGER -- 彙總的小時 (0-23)
day_of_week INTEGER
is_weekend BOOLEAN
is_holiday BOOLEAN
holiday_name STRING

-- 場域相關維度
store_city STRING
store_district STRING
store_zoning_type STRING
store_nearby_landmarks STRING
store_tags ARRAY<STRING>
sensor_location_zone STRING -- 感測器/互動發生的店內具體區域 (關鍵維度)
sensor_type STRING -- (可選) 若想區分不同技術來源的數據

-- 受眾分群維度 (來自臉部辨識等感測器，若無則為 'Unknown' 或 NULL)
estimated_age_group STRING -- 估計年齡分組 ('Unknown' if not available)
estimated_gender STRING -- 估計性別 ('Unknown' if not available)

-- 廣告內容維度 (可選，若要分析到廣告層級)
display_content_id STRING -- 播放的內容/廣告 ID ('Overall' or NULL if aggregating total traffic/views)
display_content_category STRING

-- 時間/外部因素維度
weather_condition STRING
temperature_celsius FLOAT

-- 指標欄位 (Metrics - 彙總計算的數值)

-- 流量/曝光指標
interaction_count INTEGER -- 在此週期、此維度下，感測器偵測到的獨立互動次數 (例如: 人臉出現次數, Beacon 偵測到裝置次數)
-- ^^^ 注意：這是 "互動" 次數，不是絕對的 "人數"

-- 觀看/參與指標 (主要來自視覺感測器)
gaze_interaction_count INTEGER -- 產生觀看行為的互動次數
total_gaze_duration_sec BIGINT -- 總觀看秒數
average_gaze_duration_sec FLOAT -- 平均觀看秒數 (total_gaze_duration_sec / gaze_interaction_count)
-- viewer_count INTEGER -- (可選) 估計的觀看者 "互動" 數量 (近似 gaze_interaction_count)

-- 停留指標 (來自各類感測器)
dwell_interaction_count INTEGER -- 產生停留行為的互動次數
total_dwell_time_sec BIGINT -- 區域總停留秒數
average_dwell_time_sec FLOAT -- 平均停留秒數 (total_dwell_time_sec / dwell_interaction_count)

-- 其他感測器指標 (可擴充)
-- pressure_mat_trigger_count INTEGER
-- llm_positive_sentiment_count INTEGER
-- llm_object_detected_counts MAP<STRING, INTEGER> -- e.g., {'shopping_bag': 10, 'stroller': 2}

-- (處理 double counting 的欄位 - 見說明)
total_unique_hourly_interactions INTEGER -- (可選) 若 content_id 不是 'Overall', 此欄位可儲存該小時"總"互動數 (獨立於廣告內容)
total_unique_hourly_viewers INTEGER -- (可選) 若 content_id 不是 'Overall', 此欄位可儲存該小時"總"觀看互動數 (獨立於廣告內容)
```

**關鍵設計考量與說明：**

1. **彙總週期 (Aggregation Period):** 以「小時」 (`hour_of_day`, `aggregation_timestamp`) 為基礎，這是最常見的分析粒度。

2. **核心指標 (`interaction_count`):** 這是最重要的基礎流量指標，代表在該小時、該地點、該受眾分群下，發生了多少次「互動事件」。由於無法識別同一個人，我們計算的是「次數」。例如，同一個人離開再回來，會被算作兩次互動。

3. **受眾分群 (`estimated_age_group`, `estimated_gender`):** 來自人臉辨識的數據會填入，其他感測器（如 Beacon）產生的互動紀錄，這些欄位可能是 'Unknown' 或 NULL。查詢時可以 `GROUP BY` 這些欄位來分析不同群體的行為。

4. **處理不同感測器:** ETL 流程需要定義如何將不同感測器的原始事件對應到這個彙總表的指標上。

   - 人臉辨識：提供 `interaction_count`, `gaze_interaction_count`, `total_gaze_duration_sec`, `dwell_interaction_count`, `total_dwell_time_sec`，以及 `estimated_age_group`, `estimated_gender`。

   - Beacon：主要提供 `interaction_count` (偵測到裝置), `dwell_interaction_count`, `total_dwell_time_sec` (在區域內)。

   - 紅外線/踩踏板：主要提供 `interaction_count` (觸發次數)。

   - LLM分析影像：可能提供 `interaction_count`，並填充 `llm_*` 相關指標。

5. **解決 Double Counting:**

- 在彙總維度中加入 `display_content_id`。當你想看某特定廣告 (`display_content_id = 'AD_123'`) 的數據時，直接篩選。當你想看該小時**總體**情況時，可以：

   - a) 查詢 `display_content_id = 'Overall'` 或 NULL 的紀錄（如果 ETL 中有產生這樣一筆總和紀錄）。

   - b) **或者**，在查詢時 `SUM(interaction_count) WHERE hour_of_day = X GROUP BY store_id, hour_of_day... (不含 content_id)`。但這樣得到的總數仍是「互動次數」總和，而非精確人數。

6. **可擴充性:** 可以輕易地加入新的指標欄位 (Metrics) 來對應未來新增的感測器數據 (例如 LLM 分析出的情緒分數、物件偵測計數等)。

7. **底層事件表 (Optional but Recommended):** 建議仍然保留一個更明細的事件表 (類似上一個回覆中的設計，但 `session_id` 理解為單次感測器互動 ID)，用於：

   - 作為計算彙總表的來源。

   - 進行更深入、非彙總性的問題排查或分析。

   - 未來若能實現部分跨感測器追蹤，可以在此基礎上擴充。

**如何使用這個 Schema 進行分析：**

這個彙總表讓你非常容易執行你描述的分析：

- **中午時段觀看率特別高:**

   ```sql
   SELECT
       hour_of_day,
       SUM(total_gaze_duration_sec) / SUM(gaze_interaction_count) AS avg_gaze_duration, -- 平均觀看時長
       SUM(gaze_interaction_count) / SUM(interaction_count) AS estimated_view_rate -- 估計觀看率 (觀看互動數 / 總互動數)
   FROM retail_hourly_summary
   WHERE store_id = '特定便利商店ID'
     AND hour_of_day BETWEEN 11 AND 13
     AND display_content_id = 'Overall' -- 分析總體情況
   GROUP BY hour_of_day;
   ```

- **上午人流特別多:**

   ```sql
   SELECT hour_of_day, SUM(interaction_count) as total_interactions
   FROM retail_hourly_summary
   WHERE store_id = '特定便利商店ID'
     AND hour_of_day BETWEEN 8 AND 11
     AND display_content_id = 'Overall' -- 分析總體情況
   GROUP BY hour_of_day
   ORDER BY hour_of_day;
   ```

- **下午熱食區逗留特別久:**

   ```sql
   SELECT
       hour_of_day,
       SUM(total_dwell_time_sec) / SUM(dwell_interaction_count) AS avg_dwell_time
   FROM retail_hourly_summary
   WHERE store_id = '特定便利商店ID'
     AND sensor_location_zone = '熱食區'
     AND hour_of_day BETWEEN 14 AND 17
     AND display_content_id = 'Overall' -- 分析總體情況
   GROUP BY hour_of_day;
   ```


