# **Databricks 案例筆記：Care Cost Compass Agent System**

---





#### **1\. 案例概要**



- **專案名稱：** Care Cost Compass (費用指南針)

- **目標：** 打造一個 AI Agent 聊天機器人，以 REST API 形式提供服務。使用者能透過自然語言詢問醫療程序的預估自付費用。

- **運作流程：** Agent 接收到使用者問題後，會自動化執行一連串複雜任務，包括：

   1. **理解語意：** 辨識問題中的醫療程序。

   2. **多源檢索 (RAG)：** 從 PDF 保單文件中找出相關給付條款、從資料庫查詢標準費用碼、查詢客戶目前的保險累積額度。

   3. **邏輯計算：** 根據檢索到的所有資訊，計算最終的自付金額。

   4. **生成回覆：** 將計算結果彙整成一段清晰易懂的文字回覆給使用者。



#### **2\. 特點：Databricks 內部服務託管的 Agent**



此案例的最大特點是**將 Databricks 從一個傳統的內部數據分析平台，轉變為一個能託管即時、對外 AI 應用服務的端到端平台**。它整合了從數據工程、AI 開發、安全治理到線上部署 (Serving) 的所有環節，形成一個完整的閉環。Agent 作為核心協調者，由平台內部的各種託管服務提供支援。



#### **3\. Agent 託管的服務名稱與說明**



- **服務名稱：** **Mosaic AI Model Serving**

- **說明：** 這是 Databricks 內建的 **Serverless (無伺服器) 部署平台**。開發者可以將包含 Agent 邏輯的 Python 程式碼 (打包成 MLflow `pyfunc` 模型) 一鍵部署上去。

- **功能比喻：** 類似 AWS Lambda 或 Google Cloud Run，它會自動將你的程式碼變成一個高可用、可自動擴展的 REST API 端點，並處理底層的所有維運工作。



#### **4\. Agent 可呼叫的工具和記憶相關服務**



Agent 的強大之處在於它能靈活呼叫平台上的各種工具來完成任務：

| 服務/工具名稱 | 功能說明 | 後端比喻 | 
|---|---|---|
| **Mosaic AI Vector Search** | **語意搜尋資料庫 (RAG 核心)**。用於儲存非結構化資料 (如 PDF 文件) 的向量，讓 Agent 能理解問題語意並找到最相關的資料段落。 | 一個為 AI 定制的 Elasticsearch 或 OpenSearch | 
| **Online Tables** | **高效能線上資料庫 (低延遲)**。用於存放需要快速 Key-Value 查詢的結構化資料，如客戶資料、費用表等。 | 一個內建的 Redis 或 DynamoDB | 
| **Unity Catalog** | **統一數據治理中心**。管理所有數據資產 (資料表、模型、向量索引) 的權限，確保 Agent 只能存取它被授權的資料。 | 數據目錄 + IAM 權限控管系統 | 
| **AI Gateway** | **外部 LLM 金鑰保險箱**。集中且安全地管理對外部 LLM (如 OpenAI) 的 API Key，Agent 本身不需持有敏感金鑰。 | 一個專門管理 API Key 的 Secret Manager / Vault | 



#### **5\. 延遲 (Latency) 與資安 (Security) 特別說明**



**針對延遲問題的解決方案：**

1. **高速快取 (Online Tables)：** 這是關鍵。將頻繁查詢的資料放在 Online Tables 中，實現毫秒級的快速查找，避免掃描慢速的資料倉儲。

2. **平行處理 (Parallel Execution)：** Agent 內部邏輯採用 `asyncio`，能**同時**發出多個資料查詢請求 (查保單、查費用、查客戶資料)，大幅縮短了 I/O 等待時間。

3. **簡化邏輯 (Custom PyFunc)：** 採用固定、程式化的工作流程，減少了 LLM 反覆決策的延遲，提升了反應速度。

**針對對外暴露的資安措施：**

1. **網路層防護：** API 端點本身是受管理的 Gateway，可設定 **IP 白名單**來限制來源，或部署為**私有端點**完全不暴露於公網。

2. **身份驗證：** 所有 API 請求都必須攜帶有效的**認證權杖 (Token)**，無權杖者會被直接阻擋。

3. **權限最小化 (核心安全策略)：** Agent 以一個\*\*「服務主體」(Service Principal)\*\* 的身份運行。**Unity Catalog** 會嚴格限制此身份只能存取完成任務所必需的最小數據集。即使 API 被攻破，**安全衝擊範圍也被有效控制**，無法存取到其他未經授權的敏感資料。

4. **全面監控：** 透過 **Inference Tables** 和 **Audit Logs** 記錄所有 API 的請求、回應與平台操作，提供完整的安全審計與異常行為分析能力。